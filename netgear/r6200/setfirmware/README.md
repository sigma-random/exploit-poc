##Netgear R6200 ``SetFirmware`` Exploit

This proof-of-concept exploit code targets the hidden ``SetFirmware`` SOAP method in the Netgear R6200 (and others) router's UPnP daemon. For a detailed explanation of reverse engineering and exploiting the vulnerability, see the [Broken, Abandoned, and Forgotten Code](http://shadow-file.blogspot.com/2015/04/abandoned-part-01.html) blog series.

###FILES
* ``firmware_exploit.py``:The main file in this repository. Assuming you have prepared first and second stage payloads, this script will exploit the ``SetFirmware`` vulnerability and send the first stage firmware file to the UPnP server.
* ``environment.py``: This file contains the operating parameters for the main exploit script. The purpose of each parameter is described in inline comments.
* ``setfirmware.py``: This file provides classes for exploiting the ``SetFirmware`` vulnerability. It also provides a ``main()`` test driver for use when debugging and reverse engineering ``upnpd``. This script is simpler than ``firmware_exploit.py`` as it doesn't set up necessary post-exploitation connect-back servers.
* ``firmware_building``: Various modules for building firmware images from existing kernel and filesystem blobs
* ``payload-src``: Source code and build system for stage 1 and 2 payloads.

###PREREQUISITES

The following prerequisites must be satisfied. Where appropriate, some are described in greater detail later.

*Things outside the scope of this documentation*

* Ubuntu Linux (developed and tested in an Ubuntu 12.04 virtual machine)
* Little endian MIPS Linux gcc toolchain

*Things addressed here or in another README*

* Netgear firmware update file for R6200, version 1.0.0.28_1.0.24
* Kernel image extracted from firmware update file
* SquashFS filesystem extracted from firmware update file
* Modified copy of OpenWRT mtd writer
* [Bowcaster](https://github.com/zcutlip/bowcaster)

###BUILDING

Before using this exploit you need to have built stage 1 and 2 firmware payloads. Instructions for doing that are found in ``payload-src``.

This will generate ``stage1.chk`` and ``stage2mtd.bin`` files. Put them in the ``SRVROOT`` directory specified in ``environment.py``.

###USING

You need to have [Bowcaster](https://github.com/zcutlip/bowcaster) installed.

If you want to use different IP addresses and ports for the target and for your system, the places to change those are:

* ``payload-src/stage1/src/wpsd``
* ``payload-src/stage2/src/telnetenabled``
* ``environment.py``

To use ``setfirmware.py`` for testing and debugging, edit the setfirmware script to set your target's IP address, then run:

``./setfirmware.py <firmware_image>``

After editing ``environment.py`` to match your configuration and ensuring payload files are in place, run:

``./firmware_exploit.py``

Upon rebooting, the stage 1 firmware will attempt to download the second stage from ``http://10.12.34.56:8080/stage2mtd.bin``. Then, if all goes well, there is a second reboot and then a connect-back shell to the IP address and port you specified in the ``telnetenabled`` script.

