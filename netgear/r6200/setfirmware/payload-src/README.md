###Building

Before building the stage 1 and 2 payloads, you need to provide a few pieces that aren't included here due to licensing:

* Kernel image (proprietary Netgear EULA)
* Root filesystem (proprietary Netgear EULA)
* mtd writing utility from OpenWRT (GPL licensed)

You also need a little-endian MIPS Linux gcc toolchain. Ensure ``mipsel-linux-gcc`` and friends are in your ``$PATH``.

You can extract the filesystem and kernel from a stock Netgear firmware image. I used and tested the Netgear firmware R6200-V1.0.0.28_1.0.24.chk:

    $ md5sum R6200-V1.0.0.28_1.0.24.chk
    0bbb9004c8cddf2d9602719c34c9e33e  R6200-V1.0.0.28_1.0.24.chk

Identify the offsets and sizes of the kernel and filesystem components using ``binwalk``, then extract them using `dd`:

     $ dd if=R6200-V1.0.0.28_1.0.24.chk of=squashfs.bin skip=1328446 bs=1
     $ dd if=R6200-V1.0.0.28_1.0.24.chk of=kernel-lzma.bin skip=86 bs=1 count=1328360

Put ``kernel-lzma.bin`` into ``payload-src/``.

Unpack the ``squashfs.bin`` into a root filesystem. Extracting a SquashFS filesystem is beyond the scope of this documentation.

You'll need to put a copy of the non-minimized root filesystem in place for stage 2. Put an unmodified ``rootfs.tar.gz`` in ``exploit-src/stage2/src/``.

Then, you'll need to generate a minimized root filesytem directory as described in [part 11](http://shadow-file.blogspot.com/2015/07/abandoned-part-11.html).

Tar up your minimized root filesystem, and put ``rootfs.tar.gz`` in ``exploit-src/stage1/src/``.

The mtd writer is responsible for flashing the stage 2 firmware image. I have modified this utility from OpenWRT to work with this project. Check out the source and put it in place:

    $ git clone https://github.com/zcutlip/mtdwriter.git
    $ tar zcvf broken_abandoned/part_13/exploit-src/stage1/src/mtdwriter.tar.gz mtdwriter/

With the missing pieces in place, you can build the stage 1 and 2 firmware images:

    $ cd exploit-src/
    $ ./buildmipsel.sh

This will generate ``stage1.chk`` and ``stage2mtd.bin`` files. Put them in the SRVROOT directory specified in ``environment.py``.