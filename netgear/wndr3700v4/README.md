DESCRIPTION
===========

This proof-of-concept exploit code exploits a combination of vulnerabilities in the WNDR3700v4 minidlna server.  They are similar to the ones in the WNDR3700v3 described in my Black Hat 2012/DEF CON 20 presentation. Instead of exploiting a SQL injection in the AlbumArt URL, this exploits (an even easier!) one in the <SearchCriteria> element of a ContentDirectory SOAP search.  This gives us full control over the SQLite database.  Just like on the v3 hardware, we can inject an album art record that points to arbitrary files on the filesystem, including /dev/mtdblock devices.

Further, just like in my presentation, we can inject a buffer overflow string into the database and subsequently trigger the buffer overflow by sending a browse request.  The callback() function executed by SQLite does a sprintf() of the DLNA_PN field, so we can stage an arbitrarily long string in that field and then, via SOAP request, browse for our staged record.  This is just the same as in the v3 hardware except we're exploiting a different buffer overflow; the old one isn't there in the new version.
    
USAGE
-----
Edit `environment.py` and set your target and callback IP addresses appropriately.

Ensure you have the Bowcaster exploit development framework installed:  
[https://github.com/zcutlip/bowcaster/tree/v0.1](https://github.com/zcutlip/bowcaster/tree/v0.1)

To stage a fake album art record and extract an arbitrary file from the device, run the `soap_sql_inject.py` program with the action "inject" followed by a file you want to extract:

    $ ./soap_sql_inject.py inject "/dev/mtdblock5"
    $ wget http://router_ip:8200/AlbumArt/31337-1.jpg

To exploit a buffer overflow and pop a root shell, run the `soap_sql_inject.py` program with the action "overflow".

    $ ./soap_sql_inject.py overflow

To delete all staged records from the database, run the `soap_sql_inject.py` program with the "delete" action.

    $ ./soap_sql_inject.py delete

